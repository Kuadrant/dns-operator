apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kuadrant-coredns
resources:
  - namespace.yaml
helmCharts:
  - name: coredns
    repo: https://coredns.github.io/helm
    releaseName: kuadrant
    valuesInline:
      env:
        - name: WATCH_NAMESPACES
          value: kuadrant-coredns
      isClusterService: false
      serviceType: LoadBalancer
      prometheus:
        service:
          enabled: true
        monitor:
          enabled: true
          namespace: kuadrant-coredns
      image:
        repository: quay.io/kuadrant/coredns-kuadrant
        tag: latest
        pullPolicy: Always
      servers:
        - zones:
            - zone: k.example.com
          port: 53
          plugins:
            - name: debug
            - name: errors
            - name: log
            - name: geoip
              parameters: GeoLite2-City-demo.mmdb
            - name: metadata
            - name: kuadrant
            - name: prometheus
              parameters: 0.0.0.0:9153
        - zones:
            - zone: kdrnt
          port: 53
          plugins:
            - name: debug
            - name: errors
            - name: log
            - name: kuadrant
            - name: prometheus
              parameters: 0.0.0.0:9153
        - zones:
            - zone: .
          port: 53
          plugins:
            - name: whoami
            - name: errors
            # Serves a /health endpoint on :8080, required for livenessProbe
            - name: health
              configBlock: |-
                lameduck 5s
            # Serves a /ready endpoint on :8181, required for readinessProbe
            - name: ready
            - name: prometheus
              parameters: 0.0.0.0:9153
            - name: forward
              parameters: . /etc/resolv.conf
            - name: cache
              parameters: 30
            - name: loop
            - name: reload
            - name: log
patches:
  - path: k8s_prometheus_patch.yaml
  - target:
      kind: ClusterRole
      name: kuadrant-coredns
    patch: |
      - op: add
        path: /rules/-
        value:
          apiGroups:
            - kuadrant.io
          resources:
            - dnsrecords
          verbs:
            - get
            - list
            - watch
  - patch: |
      - op: add
        path: /spec/template/spec/containers/0/env
        value:
          - name: WATCH_NAMESPACES
            value: ""
    target:
      kind: Deployment
  - target:
      kind: Service
      name: kuadrant-coredns
    patch: |
      - op: add
        path: /spec/externalTrafficPolicy
        value: Local
